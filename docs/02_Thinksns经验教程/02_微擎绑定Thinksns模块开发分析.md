微擎绑定Thinksns模块开发分析

###1. 微擎简介

微擎是一个第三方的微信公众平台引擎,基本覆盖了微信公众号平台的功能,同时支持扩展.

个人对微擎的理解,它主要有两个方向

1.作为微信和web app的桥梁

2.微信互动

而第一个方向我个人认为是当前较为热门的方向.

本文虽然作为一篇Thinksns教程,但是实际的开发环境是部署在微擎平台上的.请读者务必事前大概了解一下.

###2. 需求说明

需求很简单,但是个人当前微博营销,该功能至关重要!那就是,`用户绑定微信`,`微信直接登录3G版网页`.

功能虽然简单,但是一旦实现该功能,其他后续功能在用户绑定的基础上就容易添加了.

###3. 实现原理

由于本代码还不完善, 基本处于草稿状态能用的状态. 故源码暂时先不公开, 但是通过本教程,基本每个人都可自行实现该功能. 同时也暂时为了网站的安全性考虑!

本微擎模块参考的 微擎论坛上的[fans模块](http://bbs.we7.cc/forum.php?mod=viewthread&tid=38&highlight=fans), 在此说明,请大家参考.

####3.1 原理概述

微信和微博用户绑定,我个人理解的实现原理是,让微信用户第一次填入绑定信息(也就是微博用户信息),然后通过微博端进行验证,验证通过也就绑定成功, 而绑定成功服务器端需要做什么呢? 那就要从目的说起,目的无非是记住用户的登陆信息,下次该微信用户请求该页面直接返回其登陆信息, 点击登陆就可以了.

所以基本流程就是: 

用户输入绑定 -> 返回绑定页面 -> 用户输入微博信息,点击绑定 -> 微擎服务器端请求微博服务器,对用户名密码进行验证 -> 验证成功反馈用户,同时对登陆信息进行加密记录 -> 下次用户请求登陆或绑定 -> 返回界面附带绑定的登陆信息 -> 用户点击登录 -> 微擎服务器请求微博服务器进行登陆操作 -> 跳转至微博3G版界面返回给用户

####3.2 微擎必备知识

微擎的实现和Thinkphp实现有异曲同工之处,它将模块分为三种文件:`模板文件`,`Module文件`和`Process文件`.

模板文件: 就是你需要返回给用户的HTML界面. 该模板一般会include在 `odule 文件`和 `Process 文件`中, 模板引擎驱动.

Model文件: 是核心文件,通过链接中加入GET信息: `do=function-name` 来调用,其中 function-name 就是 model 文件中的函数名.

Processor文件: 是处理用户请求消息,相对应的处理的. 例如用户发送了 `绑定`, 你可以在这里处理收到 `绑定 `后做什么.	

其他微擎知识请参考 [微擎官方文档](http://www.we7.cc/docs/), 另外我将会近期内整理该文档到我的[文档聚合](doc.emx2.co.uk),敬请关注,如果又兴趣一起完善的也可以直接联系我.

####3.3 框架

这节介绍框架就是说,你想实现这个功能,你需要在那些文件中加入那些功能的代码:

1. processor.php 中加入处理获得绑定消息的代码:

	if ($content == "绑定"||$content == "bd") 
	{
		...
	}
	
2. module.php 中加入处理绑定动作的函数:

	public function dobangding() 
	{
		...
	}
	
3. 加入模板,显示绑定页面: (我是直接修改的一下html,显示昵称,登陆用户名和密码,然后加上绑定和登陆按钮)

	/fans/template/index.html

####3.4 具体实现方法

processor.php 处理获得绑定消息: 获得该消息,需要返回给用户一个链接或者是一个带链接的图文消息(关于类型参考微擎文档消息类型),其实重点是这个链接,这个链接需要指向你的绑定页面.

	'Url' => $_W['siteroot'] . create_url('index/module', array('do' => 'bangding', 'name' => 'fans', 'id' => $rid,'weid'=>$_W['weid'],'from_user' => base64_encode(authcode($this->message['from'], 'ENCODE')))),

有些内容还是要参考微擎的,但是你会发现`'do' => 'bangding'`,其实也就告诉你了,用户单击了这个链接,`module.php`函数中的`dobangding`函数就会执行,我们只需要把模板文件`include`到`dobangding`函数就好了.

下面我们来具体分析一下`dobangding`函数究竟做些什么?

先考虑一个问题, 用户第一次点击链接返回界面,实际用户什么信息都没发过去, 那么你也无法做出什么处理基本就是现实一个模板文件, 那下次用户单击绑定按钮时,就不一样了,但是我们还是调用的`dobangding`函数, 所以我们通过一个`action`来区分这两种调用请求.
	
	if($_GPC['action']=='setinfo')
	//如果用户是单击绑定进入该函数的,那么就开始执行绑定流程
	{
		//绑定的流水线操作!!!
	}
	include $this->template('fans/index');
	//包含模板
	
为什么这样设计呢?

考虑另一个问题, 用户第二次进入这个页面, 我们就需要获取绑定的数据, 所以现在代码架构应该是这样

	//判断用户是否绑定
	if(用户已经绑定)
	{
		//直接获取绑定的信息,返回页面
	}
	else
	{
		if($_GPC['action']=='setinfo')
		//如果用户是单击绑定进入该函数的,那么就开始执行绑定流程
		{
			//绑定的流水线操作!!!
		}
	}
	include $this->template('fans/index');
	//包含模板

有了这个框架, 下面的问题就是实现和微博系统的交互,和存储绑定信息. 下面章节继续讲解.

####3.5 数据库操作

显然,如果想和微博系统用户交互, 需要访问微博用户数据库表. (如果要是能连上ucenter就牛X了!!!)

那么首先要解决在微擎中连接微博的数据库问题!

虽然微擎中已经封装了很多数据库操作, 但是这里还是乖乖地使用PHP连接MySql的基本函数:

这里列举出了,一些常用操作, 大家请到[W3Cshcool](http://www.w3school.com.cn/)查阅!

	$conn=mysql_connect("localhost","用户名","密码");
	$mysql_db="微博数据库";
	$mysql_database_escaped = mysql_real_escape_string($mysql_db);
	$dbconnetcted = mysql_select_db($mysql_database_escaped);
	$result = mysql_query($sql);

连接数据库其实主要是为了验证用户名和密码是否正确, 通过查看Ts源码, 发现其用户验证的方法, 其实也就是用户密码加密的方法, 此处不详细讨论, 毕竟这也是个安全问题吧! 如果你找不到可以再私信,或博客上问我吧.

####3.6 绑定信息存储

一旦验证成功, 那么我们就需要存储这个信息. 这个信息存储是比较头疼的, 尤其是密码的安全性问题(由于要实现自动登录到3G版,显然需要能够保存这样一份密码,如果是手机客户端,密码肯定是存在手机端,但是微信只能存在服务器端, 所以我们只能用尽可能复杂的加密方法, 但是要可逆的...)

微擎本身有一个fans的数据库表, 由于当前难以获得微信号的更多信息,基本也就是一个`FromID`,不过它是唯一的, 用它来标识用户就好. 为这个数据库表加入几个字段, 用户名或邮箱, 密码, 加密盐, 微信昵称等信息. 然后就将用户信息插入进来就好了.

###4. 实现效果

大家请前往[@导游|idaoyou](http://www.idaoyoo.com), 加入微信公众号`idaoyoo`查看即可.

###5. 总结

我希望通过这篇文章,能够给大家一个途径来实现微信的绑定, TS客户端授权太贵啦, 走微信路线应该是目前最好的选择, 而且以后自己扩展3G版, 比客户端要更加快捷. 

当然我的方法不一定是最好的, 希望大家能共同讨论, 发现问题, 或者贡献更加成熟完善的解决方法!